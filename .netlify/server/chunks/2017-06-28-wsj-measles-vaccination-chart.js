import "clsx";
import { h as html } from "./html.js";
const metadata = {
  "title": "Reproducing the WSJ Measles Vaccination Chart Using R",
  "author": "",
  "date": "2017-06-28",
  "categories": "posts",
  "tags": ["animation", "dataviz", "ggplot2", "gganimate", "R"],
  "featured": true,
  "subtitle": "Recreate and animate the plot using R and this guide",
  "description": "Using ggplot2 and animation packages to reproduce and animate the famous Wall Street Journal Measles Incidence Chart",
  "img": "/img/gg-1.png"
};
const {
  title,
  author,
  date,
  categories,
  tags,
  featured,
  subtitle,
  description,
  img
} = metadata;
function _017_06_28_wsj_measles_vaccination_chart_md($$payload) {
  $$payload.out += `<h2>Mastering Animation in R</h2> <p><strong>UPDATE</strong>: In order to reproduce some portions of this code you need
the <code>gganimate</code> package using the deprecated API. To access that
version, download v0.1.1 <a href="https://github.com/thomasp85/gganimate/releases/tag/v0.1.1" rel="nofollow">here</a>.</p> <p>Recently I’ve been working on creating gif animations for <a href="https://twitter.com/EdNCES/status/859807520881344512" rel="nofollow">social
media</a>:</p> <blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">New from <a href="https://twitter.com/hashtag/COE2017?src=hash">\\#COE2017</a>:
21% of students reported being bullied at school in 2015, a ↓ from the
28% reported in 2005. <a href="https://t.co/5BlyLdHS9W">https://t.co/5BlyLdHS9W</a> <a href="https://t.co/Fr1pTt8xca">pic.twitter.com/Fr1pTt8xca</a></p><p>— NCES (@EdNCES)</p> <a href="https://twitter.com/EdNCES/status/859807520881344512">May 3,
2017</a></blockquote> <p>It’s pretty addicting! And not as complicated as it appears. Let’s walk
through the creation of a gif using R.</p> <h2>Wall Street Journal Measles Vaccination Chart</h2> <p>One of the more compelling data visualizations produced in recent years
is the following representation of measles incidence from 1928 to 2003
produced by the Wall Street Journal graphics team:</p> <p><img src="/img/measles.png" alt="Wall Street Journal"/></p> <p>In the two years after its release, many prominent data journalists,
designers, and developers have analyzed/applauded the design decisions
in the chart, which urge the reader to its take-home message: the
introduction of the measles vaccine <strong>drastically</strong> reduced the
incidence of the virus.</p> <p>Recognizing it’s merit, let’s accentuate that take-home message by
adding the element of animation.</p> <h2>Download dependent packages and prep the data</h2> <pre class="language-r">${html(`<code class="language-r">    library<span class="token punctuation">(</span>reshape2<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>dplyr<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>extrafont<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>ggplot2<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>gganimate<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>animation<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>grid<span class="token punctuation">)</span></code>`)}</pre> <p>We’ll use <code>reshape2</code> and <code>dplyr</code> to manipulate the data, <code>ggplot2</code> to
plot it, <code>gganimate</code> for a first animation exploration, and <code>animation</code> and <code>grid</code> for a customized finished product.</p> <h2>Download and prep the data (<a href="https://vimeo.com/139094998" rel="nofollow">everything is a remix</a>)</h2> <p>The heavy data prep and plotting for this plot has been done already!
Much of this code comes from <a href="https://benjaminlmoore.wordpress.com/2015/04/09/recreating-the-vaccination-heatmaps-in-r/" rel="nofollow">this
site</a>,
with small improvements and the inclusion of some omitted pieces. From
that site, I’ve relinked the steps to download the data:</p> <ol><li>Register and login to “Project Tycho“</li> <li>Go to level 1 data, then Search and retrieve data</li> <li>Now change a couple of options: geographic level := state; disease
outcome := incidence</li> <li>Add all states (highlight all at once with Ctrl+A (or Cmd+A on Macs)</li> <li>Hit submit and scroll down to Click here to download results to
excel</li> <li>Open in excel and export to CSV</li></ol> <p>Once we’ve got the data and you’ve set your working directory, lets read
in the file and reshape it:</p> <pre class="language-r">${html(`<code class="language-r">    measles <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/animation_samples/measles/measles.csv"</span><span class="token punctuation">,</span> skip<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    measles <span class="token operator">&lt;-</span> melt<span class="token punctuation">(</span>measles<span class="token punctuation">,</span> id.var<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token string">"YEAR"</span><span class="token punctuation">,</span> <span class="token string">"WEEK"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    colnames<span class="token punctuation">(</span>measles<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"year"</span><span class="token punctuation">,</span> <span class="token string">"week"</span><span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token punctuation">,</span> <span class="token string">"cases"</span><span class="token punctuation">)</span>
    measles<span class="token operator">$</span>cases <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>measles<span class="token operator">$</span>cases<span class="token operator">==</span><span class="token string">"-"</span><span class="token punctuation">,</span><span class="token keyword">NA</span><span class="token punctuation">,</span>measles<span class="token operator">$</span>cases<span class="token punctuation">)</span>
    measles<span class="token operator">$</span>cases <span class="token operator">&lt;-</span> as.numeric<span class="token punctuation">(</span>measles<span class="token operator">$</span>cases<span class="token punctuation">)</span></code>`)}</pre> <p>One piece I wanted to replicate was the state abbreviations used in the
figure. I used the <a href="https://en.wikipedia.org/wiki/List_of_U.S._state_abbreviations" rel="nofollow">AP style
guide</a>,
and you can access that csv through <a href="https://mikelee.co/data/stateName.csv" rel="nofollow">this
link</a>:</p> <pre class="language-r">${html(`<code class="language-r">    stateAP <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/animation_samples/measles/stateName.csv"</span><span class="token punctuation">)</span>
    stateAP<span class="token operator">$</span>stateName <span class="token operator">&lt;-</span> toupper<span class="token punctuation">(</span>stateAP<span class="token operator">$</span>stateName<span class="token punctuation">)</span>
    measles<span class="token operator">$</span>state <span class="token operator">&lt;-</span> stateAP<span class="token operator">$</span>stateAP<span class="token punctuation">[</span>match<span class="token punctuation">(</span>measles<span class="token operator">$</span>state<span class="token punctuation">,</span>stateAP<span class="token operator">$</span>stateName<span class="token punctuation">)</span><span class="token punctuation">]</span></code>`)}</pre> <p>Finally, we’ll create our measles data frame by summarizing the
incidence of measles occurring in each state by year, while also
recoding instances in which state’s have no incidence/values for a given
year as NAs.</p> <pre class="language-r">${html(`<code class="language-r">    mdf <span class="token operator">&lt;-</span> measles <span class="token percent-operator operator">%>%</span> group_by<span class="token punctuation">(</span>state<span class="token punctuation">,</span> year<span class="token punctuation">)</span> <span class="token percent-operator operator">%>%</span>
      summarise<span class="token punctuation">(</span>incidence<span class="token operator">=</span><span class="token keyword">if</span><span class="token punctuation">(</span>all<span class="token punctuation">(</span>is.na<span class="token punctuation">(</span>cases<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">NA</span> <span class="token keyword">else</span>
        sum<span class="token punctuation">(</span>cases<span class="token punctuation">,</span> na.rm<span class="token operator">=</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span>
    mdf<span class="token operator">$</span>state <span class="token operator">&lt;-</span> factor<span class="token punctuation">(</span>mdf<span class="token operator">$</span>state<span class="token punctuation">,</span> levels<span class="token operator">=</span>rev<span class="token punctuation">(</span>levels<span class="token punctuation">(</span>mdf<span class="token operator">$</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code>`)}</pre> <h2>Create the figure using <code>ggplot2</code></h2> <p>We’ll pull the colors directly from the <a href="http://graphics.wsj.com/infectious-diseases-and-vaccines/js/script.min.js" rel="nofollow">WSJ javascript source
code</a>.
We’ll also load the <em>Open Sans</em> family of fonts via <code>loadfonts()</code></p> <pre class="language-r">${html(`<code class="language-r">    cols<span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"#e7f0fa"</span><span class="token punctuation">,</span> <span class="token comment">#lighter than light blue</span>
             <span class="token string">"#c9e2f6"</span><span class="token punctuation">,</span> <span class="token comment">#light blue</span>
             <span class="token string">"#95cbee"</span><span class="token punctuation">,</span> <span class="token comment">#blue</span>
             <span class="token string">"#0099dc"</span><span class="token punctuation">,</span> <span class="token comment">#darker blue</span>
             <span class="token string">"#4ab04a"</span><span class="token punctuation">,</span> <span class="token comment">#green</span>
             <span class="token string">"#ffd73e"</span><span class="token punctuation">,</span> <span class="token comment">#yellow</span>
             <span class="token string">"#eec73a"</span><span class="token punctuation">,</span> <span class="token comment">#mustard</span>
             <span class="token string">"#e29421"</span><span class="token punctuation">,</span> <span class="token comment">#dark khaki (?)</span>
             <span class="token string">"#f05336"</span><span class="token punctuation">,</span> <span class="token comment">#orange red</span>
             <span class="token string">"#ce472e"</span><span class="token punctuation">)</span> <span class="token comment">#red</span>
    extrafont<span class="token operator">::</span>loadfonts<span class="token punctuation">(</span><span class="token punctuation">)</span></code>`)}</pre> <p>Nifty!</p> <p>Let’s shift to making the plot. The majority of the figure is generated
via these three function calls:</p> <pre class="language-r">${html(`<code class="language-r">    gg <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>mdf<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>y<span class="token operator">=</span>state<span class="token punctuation">,</span> x<span class="token operator">=</span>year<span class="token punctuation">,</span> fill<span class="token operator">=</span>incidence<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      geom_tile<span class="token punctuation">(</span>colour<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">,</span>
                width<span class="token operator">=</span><span class="token number">.9</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">.9</span><span class="token punctuation">)</span> <span class="token operator">+</span> theme_minimal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      scale_fill_gradientn<span class="token punctuation">(</span>colours<span class="token operator">=</span>cols<span class="token punctuation">,</span> limits<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           values<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.03</span><span class="token punctuation">,</span> <span class="token number">0.09</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           na.value<span class="token operator">=</span>rgb<span class="token punctuation">(</span><span class="token number">246</span><span class="token punctuation">,</span> <span class="token number">246</span><span class="token punctuation">,</span> <span class="token number">246</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           labels<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token string">"0k"</span><span class="token punctuation">,</span> <span class="token string">"1k"</span><span class="token punctuation">,</span> <span class="token string">"2k"</span><span class="token punctuation">,</span> <span class="token string">"3k"</span><span class="token punctuation">,</span> <span class="token string">"4k"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           guide<span class="token operator">=</span>guide_colourbar<span class="token punctuation">(</span>ticks<span class="token operator">=</span>T<span class="token punctuation">,</span> nbin<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
                                                 barheight<span class="token operator">=</span><span class="token number">.5</span><span class="token punctuation">,</span> label<span class="token operator">=</span>T<span class="token punctuation">,</span>
                                                 barwidth<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code>`)}</pre> <p>The most contentious design decision made by the WSJ authors is
undoubtedly the color scale. Aligning gradient color values (in our
chart as <code>values=c(0, 0.01, 0.02, 0.03, 0.09, 0.1, .15, .25, .4, .5, 1)</code>) so that
one portion of the scale is weighted more prominently than the other
accentuates the message of the chart; some might see this as ambiguous
or misleading - it’s challenging to ascribe what value a given color
stands for. Once we have the skeleton for our plot, we can add an
appropriate x axis scale, vaccine introduction line, and figure labels:</p> <pre class="language-r">${html(`<code class="language-r">    gg <span class="token operator">&lt;-</span> gg <span class="token operator">+</span>
      scale_x_continuous<span class="token punctuation">(</span>expand<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         breaks<span class="token operator">=</span>seq<span class="token punctuation">(</span><span class="token number">1930</span><span class="token punctuation">,</span> <span class="token number">2010</span><span class="token punctuation">,</span> by<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      geom_segment<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> xend<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> yend<span class="token operator">=</span><span class="token number">51.5</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">.9</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      labs<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      ggtitle<span class="token punctuation">(</span><span class="token string">"Measles"</span><span class="token punctuation">)</span></code>`)}</pre> <p>Finally, we’ll add in our theme.</p> <pre class="language-r">${html(`<code class="language-r">    gg <span class="token operator">&lt;-</span> gg <span class="token operator">+</span>
      theme<span class="token punctuation">(</span>legend.position<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.13</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            legend.direction<span class="token operator">=</span><span class="token string">"horizontal"</span><span class="token punctuation">,</span>
            legend.text<span class="token operator">=</span>element_text<span class="token punctuation">(</span>colour<span class="token operator">=</span><span class="token string">"grey20"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            plot.margin<span class="token operator">=</span>grid<span class="token operator">::</span>unit<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span><span class="token number">.5</span><span class="token punctuation">,</span><span class="token number">1.5</span><span class="token punctuation">,</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            axis.text.y<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans Regular"</span><span class="token punctuation">,</span>
                                     hjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            axis.text.x<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans Regular"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            axis.ticks.y<span class="token operator">=</span>element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            panel.grid<span class="token operator">=</span>element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            title<span class="token operator">=</span>element_text<span class="token punctuation">(</span>hjust<span class="token operator">=</span><span class="token operator">-</span><span class="token number">.07</span><span class="token punctuation">,</span> vjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                               family<span class="token operator">=</span><span class="token string">"Open Sans Semibold"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            text<span class="token operator">=</span>element_text<span class="token punctuation">(</span>family<span class="token operator">=</span><span class="token string">"Open Sans"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      annotate<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Vaccine introduced"</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">,</span>
               vjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> hjust<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span>I<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans"</span><span class="token punctuation">)</span></code>`)}</pre> <p>Voila!</p> <p><img src="/img/gg-1.png" alt="Measles Animation using animation"/></p> <h2>Explore the <code>ggplot2</code> object with <code>gganimate</code></h2> <p>It’s dang easy to create an animation using <code>gganimate</code>. Just add <code>frame</code> to the initial ggplot2 call and you’re good to go! In our plot,
we’ll want to iterate over the data years, so <code>.frame = year</code></p> <p>gganimate(gg, “/home/michael/Documents/mikeleeco.github.com/static/img/gganimate_measles.gif”)</p> <p><img src="/img/Animation/gganimate_measles.gif" alt="Measles Animation using gganimate"/></p> <p>That’s a great start! Though this could be further developed using <code>gganimate</code> I prefer to use the <code>animation</code> package’s <code>saveGIF</code> function
since I prefer the method in which multiple images can be called within
one call.</p> <h2>Refine our gif using <code>animation</code></h2> <p>The main idea behind creating our animation will be iteratively printing
images of larger subsets of our data set. In the for-loop, <code>subset(mdf, year&lt;=1928+i-1)</code> takes the i-th value to subset the data
year used in the figure. For example, for i==5, the data years 1928
through 1932 will appear in that image.</p> <p>Besides this change, and the addition of <code>frame=year</code>, our ggplot2 call
is nearly the same (I bumped up the font sizes to correspond with a
larger image size). One supplement to the chart is the addition of
pauses at critical points in the figure: in 1963 (when the measles
vaccine was introduced) and in 2003 (the final data year of the figure).
We’ll use if statements to determine whether pieces of the plot should
be “drawn” given the circumstances of the subset. Here’s our final code:</p> <pre class="language-r">${html(`<code class="language-r">    saveGIF<span class="token punctuation">(</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">76</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        gg <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>subset<span class="token punctuation">(</span>mdf<span class="token punctuation">,</span> year<span class="token operator">&lt;=</span><span class="token number">1928</span><span class="token operator">+</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aes<span class="token punctuation">(</span>y<span class="token operator">=</span>state<span class="token punctuation">,</span> x<span class="token operator">=</span>year<span class="token punctuation">,</span> fill<span class="token operator">=</span>incidence<span class="token punctuation">,</span> frame<span class="token operator">=</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          geom_tile<span class="token punctuation">(</span>colour<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">,</span>
                    width<span class="token operator">=</span><span class="token number">.9</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">.9</span><span class="token punctuation">)</span> <span class="token operator">+</span> theme_minimal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          scale_fill_gradientn<span class="token punctuation">(</span>colours<span class="token operator">=</span>cols<span class="token punctuation">,</span> limits<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               values<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.03</span><span class="token punctuation">,</span> <span class="token number">0.09</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               na.value<span class="token operator">=</span>rgb<span class="token punctuation">(</span><span class="token number">246</span><span class="token punctuation">,</span> <span class="token number">246</span><span class="token punctuation">,</span> <span class="token number">246</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               labels<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token string">"0k"</span><span class="token punctuation">,</span> <span class="token string">"1k"</span><span class="token punctuation">,</span> <span class="token string">"2k"</span><span class="token punctuation">,</span> <span class="token string">"3k"</span><span class="token punctuation">,</span> <span class="token string">"4k"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               guide<span class="token operator">=</span>guide_colourbar<span class="token punctuation">(</span>ticks<span class="token operator">=</span>T<span class="token punctuation">,</span> nbin<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
                                                     barheight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> label<span class="token operator">=</span>T<span class="token punctuation">,</span>
                                                     barwidth<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          scale_x_continuous<span class="token punctuation">(</span>expand<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             breaks<span class="token operator">=</span>seq<span class="token punctuation">(</span><span class="token number">1930</span><span class="token punctuation">,</span> <span class="token number">2010</span><span class="token punctuation">,</span> by<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> limits <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1928</span><span class="token punctuation">,</span><span class="token number">2003</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># add in vertical line for data year >= 1963 (when the vaccine was introduced)</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>max<span class="token punctuation">(</span>subset<span class="token punctuation">(</span>mdf<span class="token punctuation">,</span> year<span class="token operator">&lt;=</span><span class="token number">1928</span><span class="token operator">+</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">$</span>year<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">1963</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

         gg <span class="token operator">&lt;-</span> gg <span class="token operator">+</span> geom_segment<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> xend<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> yend<span class="token operator">=</span><span class="token number">51.5</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">)</span> <span class="token operator">+</span>
              annotate<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Vaccine introduced"</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">,</span>
                       vjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> hjust<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span>I<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans"</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># doesn't add vertical lineif before 1963! instead annotate with text ""</span>
            gg <span class="token operator">&lt;-</span> gg <span class="token operator">+</span>
              annotate<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">1963</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">,</span>
                       vjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> hjust<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span>I<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans"</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>
        gg <span class="token operator">&lt;-</span> gg <span class="token operator">+</span> labs<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          ggtitle<span class="token punctuation">(</span><span class="token string">"Measles"</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          theme<span class="token punctuation">(</span>legend.position<span class="token operator">=</span>c<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.075</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                legend.direction<span class="token operator">=</span><span class="token string">"horizontal"</span><span class="token punctuation">,</span>
                legend.text<span class="token operator">=</span>element_text<span class="token punctuation">(</span>colour<span class="token operator">=</span><span class="token string">"grey20"</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans Regular"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                plot.margin<span class="token operator">=</span>grid<span class="token operator">::</span>unit<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span><span class="token number">.5</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">,</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis.text.y<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">,</span> family<span class="token operator">=</span><span class="token string">"Open Sans Regular"</span><span class="token punctuation">,</span>
                                         hjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis.text.x<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">,</span>family<span class="token operator">=</span><span class="token string">"Open Sans Regular"</span><span class="token punctuation">,</span>margin<span class="token operator">=</span>margin<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis.ticks.y<span class="token operator">=</span>element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis.line.x<span class="token operator">=</span>element_line<span class="token punctuation">(</span>colour <span class="token operator">=</span> <span class="token string">"grey50"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis.ticks.length<span class="token operator">=</span>unit<span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token string">"cm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis.ticks.x<span class="token operator">=</span>element_line<span class="token punctuation">(</span>colour <span class="token operator">=</span> <span class="token string">"grey50"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                panel.grid<span class="token operator">=</span>element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                title<span class="token operator">=</span>element_text<span class="token punctuation">(</span>hjust<span class="token operator">=</span><span class="token operator">-</span><span class="token number">.07</span><span class="token punctuation">,</span> vjust<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">36</span><span class="token punctuation">,</span>
                                   family<span class="token operator">=</span><span class="token string">"Open Sans Semibold"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                text<span class="token operator">=</span>element_text<span class="token punctuation">(</span>family<span class="token operator">=</span><span class="token string">"Open Sans"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># adding in pauses for data year == 1963 (when the vaccine was introduced) and 2003 (the last year in our data)</span>
        <span class="token comment"># the replicate() function will take a ggplot2 object and print it n-times via grid.draw()</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>max<span class="token punctuation">(</span>subset<span class="token punctuation">(</span>mdf<span class="token punctuation">,</span> year<span class="token operator">&lt;=</span><span class="token number">1928</span><span class="token operator">+</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">$</span>year<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1963</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          replicate<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span>grid.draw<span class="token punctuation">(</span>gg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>max<span class="token punctuation">(</span>subset<span class="token punctuation">(</span>mdf<span class="token punctuation">,</span> year<span class="token operator">&lt;=</span><span class="token number">1928</span><span class="token operator">+</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">$</span>year<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2003</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            replicate<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span>grid.draw<span class="token punctuation">(</span>gg<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      print<span class="token punctuation">(</span>gg<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token punctuation">,</span>movie.name<span class="token operator">=</span><span class="token string">"/home/michael/Documents/mikeleeco.github.com/static/img/measles.gif"</span><span class="token punctuation">,</span>interval <span class="token operator">=</span> <span class="token number">.1</span><span class="token punctuation">,</span> ani.width <span class="token operator">=</span> <span class="token number">2050</span><span class="token punctuation">,</span> ani.height <span class="token operator">=</span> <span class="token number">1550</span><span class="token punctuation">)</span></code>`)}</pre> <p><img src="/img/Animation/measlesCompressed.gif" alt="Measles Animation using animation"/></p> <h3>Addendum - Gif File Size Management:</h3> <p>Customized gifs can get super large. The version above tops of at 73.4
MB! We’ll need to reduce that size for . One source for an #rstats
solution is <a href="http://stla.github.io/stlapblog/posts/AnimatedGifs.html" rel="nofollow">this
site</a> - which
uses the open source tool <a href="https://github.com/kohler/gifsicle" rel="nofollow">gifsicle</a> to reduce gif file sizes. Let’s port this author’s <code>gif_compress</code> script
to minimize our measles gif:</p> <pre class="language-r">${html(`<code class="language-r">    gif_compress <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ingif<span class="token punctuation">,</span> outgif<span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span> extra.opts<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      command <span class="token operator">&lt;-</span>  sprintf<span class="token punctuation">(</span><span class="token string">"gifsicle -O3 %s &lt; %s > %s"</span><span class="token punctuation">,</span> extra.opts<span class="token punctuation">,</span> ingif<span class="token punctuation">,</span> outgif<span class="token punctuation">)</span>
      system.fun <span class="token operator">&lt;-</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>.Platform<span class="token operator">$</span>OS.type <span class="token operator">==</span> <span class="token string">"windows"</span><span class="token punctuation">)</span> shell <span class="token keyword">else</span> system
      <span class="token keyword">if</span><span class="token punctuation">(</span>show<span class="token punctuation">)</span> message<span class="token punctuation">(</span><span class="token string">"Executing: "</span><span class="token punctuation">,</span> strwrap<span class="token punctuation">(</span>command<span class="token punctuation">,</span> exdent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> prefix <span class="token operator">=</span> <span class="token string">"&#92;n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      system.fun<span class="token punctuation">(</span>ifelse<span class="token punctuation">(</span>.Platform<span class="token operator">$</span>OS.type <span class="token operator">==</span> <span class="token string">"windows"</span><span class="token punctuation">,</span> sprintf<span class="token punctuation">(</span><span class="token string">""%s""</span><span class="token punctuation">,</span> shQuote<span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    gif_compress<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/mikeleeco.github.com/static/img/measles.gif"</span><span class="token punctuation">,</span><span class="token string">"/home/michael/Documents/mikeleeco.github.com/static/img/measlesCompressed.gif"</span><span class="token punctuation">,</span>extra.opts<span class="token operator">=</span><span class="token string">"--colors 256"</span><span class="token punctuation">)</span>

    <span class="token comment">## Executing:</span>
    <span class="token comment">## gifsicle -O3 --colors 256 &lt;</span>
    <span class="token comment">##   /home/michael/Documents/mikeleeco.github.com/static/img/measles.gif ></span>
    <span class="token comment">##   /home/michael/Documents/mikeleeco.github.com/static/img/measlesCompressed.gif</span>

    file.size<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/mikeleeco.github.com/static/img/measles.gif"</span><span class="token punctuation">)</span>

    <span class="token comment">## [1] NA</span>

    file.size<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/mikeleeco.github.com/static/img/measlesCompressed.gif"</span><span class="token punctuation">)</span>

    <span class="token comment">## [1] NA</span></code>`)}</pre> <p>Still large but more manageable.</p>`;
}
export {
  _017_06_28_wsj_measles_vaccination_chart_md as default,
  metadata
};
