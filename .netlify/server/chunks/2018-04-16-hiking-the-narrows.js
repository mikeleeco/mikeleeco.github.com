import "clsx";
import { h as html } from "./html.js";
const metadata = {
  "title": "Seasonal Virgin River Narrows Discharge",
  "author": "",
  "date": "2018-04-16",
  "categories": "posts",
  "tags": ["animation", "dataviz", "dplyr", "ggplot2", "lubridate", "R"],
  "featured": false,
  "subtitle": "Why I probably won't be hiking The Narrows this April",
  "description": "Investigate and visualize the USGS water discharge data for the Virgin River Narrows from 1993 - 2018",
  "img": "/img/narrowsLargeTall.png"
};
const {
  title,
  author,
  date,
  categories,
  tags,
  featured,
  subtitle,
  description,
  img
} = metadata;
function _018_04_16_hiking_the_narrows_md($$payload) {
  $$payload.out += `<p>This April I’m visiting Zion National Park, one of North America’s most
interesting locations to explore geologic formations. One such venue in
the park is an iconic hike referred to as <em>The Narrows</em>:</p> <p><img src="/img/narrows.jpg" alt="The Narrows in Zion National Park"/></p> <p>It’s surely even more sensational in person.</p> <p>Unfortunately, there’s a catch: the Virgin River, a Colorado river
tributary that shaped the distinct rock walls of The Narrows, has
seasonal water level changes that can force hikers to trek waist deep in
the river or close the route entirely. Online sources confirmed my
intuition that the spring run-off leads to closures, but I was curious
the extent of seasonality. Let’s dig into it!</p> <h2>Accessing the data</h2> <p>The provisional data for the East Fork of the Virgin River can be easily <a href="https://waterdata.usgs.gov/ut/nwis/uv?cb_00065=on&amp;cb_00060=on&amp;format=gif_default&amp;period=60&amp;begin_date=&amp;end_date=&amp;site_no=09404900" rel="nofollow">accessed via the USGS website</a>,
including discharge and gage height. I’ll focus on the discharge levels
here, since the speed of the river (and not it’s height) is what seems
to precipitate closures. The speed threshold that merits closure of The
Narrows was inconsistent across the sites I investigated but the level I saw most often - 150 cfs - is what I
will use.</p> <p>A brief aside: the USGS logs some super interesting data to visualize
time series. Here are some continually updated <a href="https://waterdata.usgs.gov/ut/nwis/uv?cb_00065=on&amp;cb_00060=on&amp;format=gif_default&amp;period=60" rel="nofollow">sources of water data for Utah</a>,
for example. So much to explore!</p> <p>Back to The Narrows data. So we’ve got out the csv and it was completely
clean like always the end! Not.</p> <h2>Cleaning the data</h2> <p>There was quite a few strange coding choices made through the years
accessed (1993 - 2018). What follows are those gory recoding details.
One nifty function I learned more about was <code>dplyr::separate</code> which
allows you to specify the direction you’d like to merge the characters
you’re separating. This allowed me to push values of <code>0 seconds</code> ino the
seconds column, even though there were some values where there were no
adjoining hours or minutes attached. Nifty!</p> <pre class="language-r">${html(`<code class="language-r">    library<span class="token punctuation">(</span>dplyr<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>tidyr<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>ggplot2<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>lubridate<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>animation<span class="token punctuation">)</span>
    library<span class="token punctuation">(</span>grid<span class="token punctuation">)</span>
    x <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/Github/mikeleeco.github.com/static/data/narrows.Rdata"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
    x <span class="token operator">&lt;-</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">530086</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
    x2 <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"/home/michael/Documents/Github/mikeleeco.github.com/static/data/narrows2.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
    x <span class="token operator">&lt;-</span> rbind<span class="token punctuation">(</span>x<span class="token punctuation">,</span>x2<span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>
    x <span class="token operator">&lt;-</span> x <span class="token percent-operator operator">%>%</span> separate<span class="token punctuation">(</span>datetime<span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> extra <span class="token operator">=</span> <span class="token string">"merge"</span><span class="token punctuation">)</span>
    x<span class="token operator">$</span>date <span class="token operator">&lt;-</span> mdy<span class="token punctuation">(</span>x<span class="token operator">$</span>date<span class="token punctuation">)</span>
    x<span class="token operator">$</span>timeparse <span class="token operator">&lt;-</span> hm<span class="token punctuation">(</span>x<span class="token operator">$</span>time<span class="token punctuation">)</span>
    x <span class="token operator">&lt;-</span> x <span class="token percent-operator operator">%>%</span> separate<span class="token punctuation">(</span>timeparse<span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token string">"hour"</span><span class="token punctuation">,</span> <span class="token string">"minute"</span><span class="token punctuation">,</span> <span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> extra <span class="token operator">=</span> <span class="token string">"merge"</span><span class="token punctuation">,</span> fill <span class="token operator">=</span> <span class="token string">"left"</span><span class="token punctuation">)</span>
    x<span class="token operator">$</span>hour <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> x<span class="token operator">$</span>hour<span class="token punctuation">)</span>
    x<span class="token operator">$</span>minute <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> x<span class="token operator">$</span>minute<span class="token punctuation">)</span>
    x<span class="token operator">$</span>second <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> x<span class="token operator">$</span>second<span class="token punctuation">)</span>
    x<span class="token punctuation">[</span><span class="token punctuation">,</span>c<span class="token punctuation">(</span><span class="token string">"hour"</span><span class="token punctuation">,</span><span class="token string">"minute"</span><span class="token punctuation">,</span><span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> sapply<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span>c<span class="token punctuation">(</span><span class="token string">"hour"</span><span class="token punctuation">,</span><span class="token string">"minute"</span><span class="token punctuation">,</span><span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as.numeric<span class="token punctuation">)</span>
    x<span class="token operator">$</span>hour <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>is.na<span class="token punctuation">(</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">,</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span>
    x<span class="token operator">$</span>minute <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>is.na<span class="token punctuation">(</span>x<span class="token operator">$</span>minute<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">,</span>x<span class="token operator">$</span>minute<span class="token punctuation">)</span>
    x<span class="token operator">$</span>hour <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>grepl<span class="token punctuation">(</span><span class="token string">"PM"</span><span class="token punctuation">,</span> x<span class="token operator">$</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token operator">$</span>hour <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">,</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span>
    x<span class="token operator">$</span>hour <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>nchar<span class="token punctuation">(</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> paste0<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">,</span>as.character<span class="token punctuation">(</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>as.character<span class="token punctuation">(</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x<span class="token operator">$</span>minute <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>nchar<span class="token punctuation">(</span>x<span class="token operator">$</span>minute<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> paste0<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">,</span>as.character<span class="token punctuation">(</span>x<span class="token operator">$</span>minute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>as.character<span class="token punctuation">(</span>x<span class="token operator">$</span>minute<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x<span class="token operator">$</span>second <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>nchar<span class="token punctuation">(</span>x<span class="token operator">$</span>second<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> paste0<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">,</span>as.character<span class="token punctuation">(</span>x<span class="token operator">$</span>second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>as.character<span class="token punctuation">(</span>x<span class="token operator">$</span>second<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x<span class="token operator">$</span>hour <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>grepl<span class="token punctuation">(</span><span class="token string">"24"</span><span class="token punctuation">,</span> x<span class="token operator">$</span>hour<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"00"</span><span class="token punctuation">,</span>x<span class="token operator">$</span>hour<span class="token punctuation">)</span>
    x<span class="token operator">$</span>timeUpdate <span class="token operator">&lt;-</span> paste<span class="token punctuation">(</span>x<span class="token operator">$</span>hour<span class="token punctuation">,</span>x<span class="token operator">$</span>minute<span class="token punctuation">,</span>x<span class="token operator">$</span>second<span class="token punctuation">,</span> sep <span class="token operator">=</span> <span class="token string">":"</span><span class="token punctuation">)</span>
</code>`)}</pre> <p>The full data source as an <strong>.Rdata</strong> file can be accessed through <a href="https://mikelee.co/data/narrows.Rdata" rel="nofollow">this
link</a>:</p> <h2>Drill down and visualize</h2> <p>The <code>dplyr</code> and <code>lubridate</code> package make it easy to extract seasonality
in the data:</p> <pre class="language-r">${html(`<code class="language-r">    dischargeByDay <span class="token operator">&lt;-</span> x <span class="token percent-operator operator">%>%</span> mutate<span class="token punctuation">(</span>day <span class="token operator">=</span> yday<span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%>%</span>
      group_by<span class="token punctuation">(</span>day<span class="token punctuation">)</span> <span class="token percent-operator operator">%>%</span>
      summarise<span class="token punctuation">(</span>avgDischarge <span class="token operator">=</span> mean<span class="token punctuation">(</span>discharge<span class="token punctuation">,</span> na.rm <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    dischargeByDay<span class="token operator">$</span>day <span class="token operator">&lt;-</span> as.Date<span class="token punctuation">(</span>as_date<span class="token punctuation">(</span>dischargeByDay<span class="token operator">$</span>day<span class="token punctuation">)</span><span class="token punctuation">)</span>
    dischargeByDay<span class="token operator">$</span>month <span class="token operator">&lt;-</span> month<span class="token punctuation">(</span>dischargeByDay<span class="token operator">$</span>day<span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>

    plot<span class="token punctuation">(</span>dischargeByDay<span class="token operator">$</span>day<span class="token punctuation">,</span> dischargeByDay<span class="token operator">$</span>avgDischarge<span class="token punctuation">)</span></code>`)}</pre> <p><img src="/img/drilldown-1.png" alt="Scatterplot: on average from 1993 to 2018, after about 100 days and lasting until about the 160th day (April 10th - June 10th), the discharge level breaks the 150 cfs threshold that closes The Narrows hiking route"/></p> <p>This result is convincing on it’s own: on average from 1993 to 2018,
after about 100 days and lasting until about the 160th day (April 10th -
June 10th), the discharge level breaks the 150 cfs threshold that closes
The Narrows hiking route.</p> <p>Lets take this result and make it more visually engaging by adding some
animation.</p> <h2>Start with our skeleton plot</h2> <p>I’ve been poking around with image dimensions and themes for
distribution through twitter, and the following theme seems to be a
quality balance between plot elements:</p> <pre class="language-r">${html(`<code class="language-r">    theme_white <span class="token operator">&lt;-</span> theme<span class="token punctuation">(</span>text <span class="token operator">=</span> element_text<span class="token punctuation">(</span>family<span class="token operator">=</span><span class="token string">"Open Sans"</span><span class="token punctuation">,</span> color <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         panel.grid <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         panel.border <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         axis.title.x<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> family <span class="token operator">=</span> <span class="token string">"Open Sans"</span><span class="token punctuation">,</span> margin <span class="token operator">=</span> margin<span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         axis.title.y<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> family <span class="token operator">=</span> <span class="token string">"Open Sans"</span><span class="token punctuation">,</span> margin <span class="token operator">=</span> margin<span class="token punctuation">(</span>r<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> l <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         axis.text.x<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">,</span> hjust <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> family <span class="token operator">=</span> <span class="token string">"Open Sans Light"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         axis.text.y<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">,</span> family <span class="token operator">=</span> <span class="token string">"Open Sans Light"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         axis.ticks <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         plot.title<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">34</span><span class="token punctuation">,</span>family <span class="token operator">=</span> <span class="token string">"Open Sans Extrabold"</span><span class="token punctuation">,</span>hjust<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>lineheight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> margin <span class="token operator">=</span> margin<span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         plot.subtitle<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> margin <span class="token operator">=</span> margin<span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>family <span class="token operator">=</span> <span class="token string">"Open Sans"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         plot.caption<span class="token operator">=</span>element_text<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> hjust <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>margin<span class="token operator">=</span>margin<span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lineheight<span class="token operator">=</span><span class="token number">1.15</span><span class="token punctuation">,</span> family <span class="token operator">=</span> <span class="token string">"Open Sans"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         legend.position<span class="token operator">=</span><span class="token string">"none"</span>
    <span class="token punctuation">)</span></code>`)}</pre> <p>It’s important to impelement limits and breaks in the y and x scales to
keep the axes stable when using ggplot2 for animation. Otherwise, the
plot axes will expand according to the subset of data used in the
figure.</p> <pre class="language-r">${html(`<code class="language-r">    gg <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>dischargeByDay<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> day<span class="token punctuation">,</span> y <span class="token operator">=</span> avgDischarge<span class="token punctuation">,</span> group <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      scale_y_continuous<span class="token punctuation">(</span>limits <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expand <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      scale_x_date<span class="token punctuation">(</span>date_breaks <span class="token operator">=</span> <span class="token string">"1 month"</span><span class="token punctuation">,</span> date_labels <span class="token operator">=</span>  <span class="token string">"%b"</span><span class="token punctuation">,</span> expand <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>limits <span class="token operator">=</span> c<span class="token punctuation">(</span>min<span class="token punctuation">(</span>dischargeByDay<span class="token operator">$</span>day<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>max<span class="token punctuation">(</span>dischargeByDay<span class="token operator">$</span>day<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      labs<span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">"Mean Flow of the VIRGIN RIVER NARROWS by day (1993 - 2018)"</span><span class="token punctuation">,</span>
           subtitle <span class="token operator">=</span> <span class="token string">"If the river is flowing at over 150 Cubic Feet per Second (CFS) the narrows is closed"</span><span class="token punctuation">,</span>
           caption <span class="token operator">=</span> <span class="token string">"Data Accessed 3/16/2018, retrieved via https://nwis.waterdata.usgs.gov/usa/nwis/uv/"</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      xlab<span class="token punctuation">(</span><span class="token string">"Date"</span><span class="token punctuation">)</span> <span class="token operator">+</span> ylab<span class="token punctuation">(</span><span class="token string">"Average Discharge"</span><span class="token punctuation">)</span> <span class="token operator">+</span>
      theme_bw<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> theme_white
    gg</code>`)}</pre> <p><img src="/img/gg.png" alt="Mean Flow of the VIRGIN RIVER NARROWS by day (1993 -2018)"/></p> <p>We’ll then use <code>tweenr</code> and <code>animation</code> to refine the visualization with
smooth transitions.</p> <h2>Animate all the things!</h2> <pre class="language-r">${html(`<code class="language-r">    gifReplicate <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      grid.newpage<span class="token punctuation">(</span><span class="token punctuation">)</span>
      grid.draw<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    yDates <span class="token operator">&lt;-</span> seq<span class="token punctuation">(</span>from <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> to <span class="token operator">=</span> max<span class="token punctuation">(</span>as.numeric<span class="token punctuation">(</span>dischargeByDay<span class="token operator">$</span>day<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    yDates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">1</span>

    saveGIF<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> yDates<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        gg2 <span class="token operator">&lt;-</span> gg <span class="token operator">+</span> geom_point<span class="token punctuation">(</span>data <span class="token operator">=</span> subset<span class="token punctuation">(</span>dischargeByDay<span class="token punctuation">,</span> day <span class="token operator">&lt;=</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> day<span class="token punctuation">,</span> y <span class="token operator">=</span> avgDischarge<span class="token punctuation">)</span><span class="token punctuation">,</span> alpha <span class="token operator">=</span> <span class="token number">.1</span><span class="token punctuation">)</span>
        g <span class="token operator">&lt;-</span> ggplotGrob<span class="token punctuation">(</span>gg2<span class="token punctuation">)</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"caption"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"subtitle"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        grid<span class="token operator">::</span>grid.draw<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
        grid.newpage<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      grid<span class="token operator">::</span>grid.draw<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
      replicate<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>gifReplicate<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> seq<span class="token punctuation">(</span>from <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> to <span class="token operator">=</span> <span class="token number">366</span><span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        gg3 <span class="token operator">&lt;-</span> gg2 <span class="token operator">+</span> geom_segment<span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> xend <span class="token operator">=</span> i<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">,</span>yend <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">,</span> color<span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">,</span> linetype <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
        g <span class="token operator">&lt;-</span> ggplotGrob<span class="token punctuation">(</span>gg3<span class="token punctuation">)</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"caption"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"subtitle"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        grid<span class="token operator">::</span>grid.draw<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
        grid.newpage<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> yDates<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        gg4 <span class="token operator">&lt;-</span> gg3 <span class="token operator">+</span> stat_smooth<span class="token punctuation">(</span>data <span class="token operator">=</span> subset<span class="token punctuation">(</span>dischargeByDay<span class="token punctuation">,</span> day <span class="token operator">&lt;=</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> aes<span class="token punctuation">(</span>x <span class="token operator">=</span> day<span class="token punctuation">)</span><span class="token punctuation">,</span> se <span class="token operator">=</span> F<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"lm"</span><span class="token punctuation">,</span> formula <span class="token operator">=</span> y <span class="token operator">~</span> poly<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        g <span class="token operator">&lt;-</span> ggplotGrob<span class="token punctuation">(</span>gg4<span class="token punctuation">)</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"caption"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        g<span class="token operator">$</span>layout<span class="token operator">$</span>l<span class="token punctuation">[</span>g<span class="token operator">$</span>layout<span class="token operator">$</span>name <span class="token operator">==</span> <span class="token string">"subtitle"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">3</span>
        grid<span class="token operator">::</span>grid.draw<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
        grid.newpage<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      grid<span class="token operator">::</span>grid.draw<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
      replicate<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span>gifReplicate<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span>
  grid.draw<span class="token punctuation">(</span>gg4<span class="token punctuation">)</span>
  geom_hline<span class="token punctuation">(</span>yintercept <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">,</span> color<span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">,</span> linetype <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span>
    geom_line<span class="token punctuation">(</span>aes<span class="token punctuation">(</span>x<span class="token operator">=</span>day<span class="token punctuation">,</span> y<span class="token operator">=</span>avgDischarge<span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">1.3</span><span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>movie.name<span class="token operator">=</span>paste0<span class="token punctuation">(</span>getwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"/narrowsLarge.gif"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>interval <span class="token operator">=</span> <span class="token number">.02</span><span class="token punctuation">,</span> ani.width <span class="token operator">=</span> <span class="token number">1200</span><span class="token punctuation">,</span> ani.height <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">)</span>

    gif_compress <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ingif<span class="token punctuation">,</span> outgif<span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span> extra.opts<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      command <span class="token operator">&lt;-</span>  sprintf<span class="token punctuation">(</span><span class="token string">"gifsicle -O3 %s &lt; %s > %s"</span><span class="token punctuation">,</span> extra.opts<span class="token punctuation">,</span> ingif<span class="token punctuation">,</span> outgif<span class="token punctuation">)</span>
      system.fun <span class="token operator">&lt;-</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>.Platform<span class="token operator">$</span>OS.type <span class="token operator">==</span> <span class="token string">"windows"</span><span class="token punctuation">)</span> shell <span class="token keyword">else</span> system
      <span class="token keyword">if</span><span class="token punctuation">(</span>show<span class="token punctuation">)</span> message<span class="token punctuation">(</span><span class="token string">"Executing: "</span><span class="token punctuation">,</span> strwrap<span class="token punctuation">(</span>command<span class="token punctuation">,</span> exdent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> prefix <span class="token operator">=</span> <span class="token string">"&#92;n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      system.fun<span class="token punctuation">(</span>ifelse<span class="token punctuation">(</span>.Platform<span class="token operator">$</span>OS.type <span class="token operator">==</span> <span class="token string">"windows"</span><span class="token punctuation">,</span> sprintf<span class="token punctuation">(</span><span class="token string">""%s""</span><span class="token punctuation">,</span> shQuote<span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    gif_compress<span class="token punctuation">(</span>paste0<span class="token punctuation">(</span>getwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"/narrowsLarge.gif"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 paste0<span class="token punctuation">(</span>getwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"/narrowsLargeTall.gif"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code>`)}</pre> <p><img src="/img/Animation/narrowsLargeTall.gif" alt="Mean Flow of the VIRGIN RIVER NARROWS by day (1993 -2018)"/></p> <h3>Addendum - Further Data Exploration Needed:</h3> <p>After generating this animation and before sitting down to write this
post, I explored the data a little bit more. To my delight (or chagrin)
there appears to be a daily pattern to the discharge level. Looking at
just April results, the discharge level decreases from 2pm to 5pm before
reversing course and increasing until about 2am.</p> <pre class="language-r">${html(`<code class="language-r">    dischargeByAprilHour <span class="token operator">&lt;-</span> x <span class="token percent-operator operator">%>%</span> filter<span class="token punctuation">(</span>month<span class="token punctuation">(</span>date<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%>%</span>
      mutate<span class="token punctuation">(</span>day <span class="token operator">=</span> yday<span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%>%</span>
      group_by<span class="token punctuation">(</span>hour<span class="token punctuation">)</span> <span class="token percent-operator operator">%>%</span>
      summarise<span class="token punctuation">(</span>avgDischarge <span class="token operator">=</span> mean<span class="token punctuation">(</span>discharge<span class="token punctuation">,</span> na.rm <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plot<span class="token punctuation">(</span>dischargeByAprilHour<span class="token operator">$</span>hour<span class="token punctuation">,</span> dischargeByAprilHour<span class="token operator">$</span>avgDischarge<span class="token punctuation">)</span></code>`)}</pre> <p><img src="/img/dailyApril.png" alt="Scatterplot: April Discharge by Hour"/></p> <p>An exploration for another day or another analyst!</p> <hr/>`;
}
export {
  _018_04_16_hiking_the_narrows_md as default,
  metadata
};
